
**90% 的“应用内模块”都应该用 `target_sources(app PRIVATE …)`；  
只有“库/驱动级模块”才用 `zephyr_library()`。**

下面给你一个**清晰、不纠结、以后不会返工**的判断标准。

---

## 一句话规则（记住这句就够了）

> **“不打算被别的 app 复用的模块 → `target_sources(app PRIVATE)`”**  
> **“可能复用 / 像驱动 / 有独立语义的模块 → `zephyr_library()`”**

---

## 一、什么时候“模块”也应该用 `target_sources(app PRIVATE)`？

### ✅ 这些情况 **强烈推荐用 `target_sources(app PRIVATE)`**

|场景|原因|
|---|---|
|应用业务模块|本来就属于 app|
|net / http / para / state|不是驱动|
|不会被别的工程用|没必要做 library|
|只服务当前 main|PRIVATE 语义最准确|
|想消除 zephyr_library 提示|这是唯一“官方语义正确”的方式|

### 示例（推荐）

```cmake
# src/net/init/CMakeLists.txt
target_sources(app PRIVATE
  net_init.c
  net_l2_event.c
)

target_include_directories(app PRIVATE .)
```

✔ 没 warning  
✔ 结构还在  
✔ CMake 语义正确

---

## 二、什么时候“模块”不该用 `target_sources(app)`？

### ❌ 不要用在这些地方

|模块类型|原因|
|---|---|
|driver|应是 library|
|硬件抽象层|可能被复用|
|可独立测试模块|library 更合适|
|未来可能拆走|用 zephyr_library|

### 示例（正确）

```cmake
# src/driver/bt/CMakeLists.txt
zephyr_library()

zephyr_library_sources(ble_module.c)
zephyr_library_include_directories(.)
```

---

## 三、PRIVATE / PUBLIC / INTERFACE 怎么选？

### 在 Zephyr 应用中，**99% 用 PRIVATE**

```cmake
target_sources(app PRIVATE ...)
target_include_directories(app PRIVATE ...)
```

#### 为什么？

- app 是最终可执行文件
    
- 没有“下游 target”
    
- PUBLIC / INTERFACE 没意义
    

---

## 四、一个“混合示例”（真实工程推荐）

```text
src/
├── app/            ← target_sources(app)
│   └── CMakeLists.txt
├── service/        ← target_sources(app)
│   └── CMakeLists.txt
├── net/            ← target_sources(app)
│   └── CMakeLists.txt
├── driver/         ← zephyr_library()
│   ├── bt/
│   └── led/
```

### 父层调度不变

```cmake
add_subdirectory(app)
add_subdirectory(service)
add_subdirectory(net)
add_subdirectory(driver)
```

---

## 五、你现在这套工程的“直接结论”

结合你前面的目录和问题，我给你一个**明确答案**：

### 👉 **这些模块：用 `target_sources(app PRIVATE)`**

- `src/net/init`
    
- `src/net/http`
    
- `src/net/modules/*`
    
- `src/para`
    

### 👉 **这些模块：继续用 `zephyr_library()`**

- `src/driver/bt`
    
- `src/driver/led`
    
- `src/driver/key`
    
- `src/driver/eeprom`
    
- `src/driver/rtc`
    

---

## 六、为什么这是“最优雅”的方案？

| 目标                   | 是否满足 |
| -------------------- | ---- |
| 消除 zephyr_library 提示 | ✅    |
| 不牺牲目录结构              | ✅    |
| 语义清晰                 | ✅    |
| 符合 Zephyr 官方习惯       | ✅    |
| 未来可升级                | ✅    |

---

## 最后一条“工程级忠告”

> **不要为了“模块感”去用 `zephyr_library()`，  
> Zephyr 的模块 ≠ 你应用里的逻辑模块。**

如果你愿意，我可以 **直接帮你画一张“你这个工程的模块分层图 + 对应 CMake 写法”**，让你以后一眼就不会用错。

