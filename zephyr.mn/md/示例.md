
基础变量:

| DT_DRV_COMPAT | wiznet_w5500 |
| ------------- | ------------ |

---
node_id:
```
DT_DRV_INST(0) => DT_INST(inst, DT_DRV_COMPAT) =>DT_INST(0, wch_ch395_spi)
=> UTIL_CAT(DT_N_INST, DT_DASH(0, wch_ch395_spi))
=> DT_N_INST_0_wch_ch395_spi

=> DT_N_S_soc_S_spi_40013000_S_w5500_0
```

```c
#define ETH_NET_DEVICE_DT_INST_DEFINE(inst, ...) \
	ETH_NET_DEVICE_DT_DEFINE(DT_DRV_INST(inst), __VA_ARGS__)
```

| node_id | DT_DRV_INST(0) | DT_N_S_soc_S_spi_40013000_S_w5500_0 |
| ------- | -------------- | ----------------------------------- |

> DT_DRV_INST(0): 它的目的是将一个简单的数字（实例索引）转换成一个全局唯一的、代表设备树节点的 **C 宏标识符**。
> 这种设计实现了 **“代码与硬件分离”**：
> - **驱动代码**：只需要写 `DT_DRV_INST(0)`，它不关心硬件到底挂在哪个总线上。
> - **设备树**：负责定义硬件的具体位置。
> - **宏系统**：负责把这两者通过生成的 ID 强行“粘”在一起。

# [[ETH_NET_DEVICE_DT_INST_DEFINE]]
```
ETH_NET_DEVICE_DT_INST_DEFINE(0,
		    w5500_init, NULL,
		    &w5500_0_runtime, &w5500_0_config,
		    CONFIG_ETH_INIT_PRIORITY, &w5500_api_funcs, NET_ETH_MTU);
```

# [[ETH_NET_DEVICE_DT_DEFINE]]
```c
#define ETH_NET_DEVICE_DT_DEFINE(node_id, init_fn, pm, data, config, prio, api, mtu)			\
	Z_ETH_NET_DEVICE_INIT(node_id, Z_DEVICE_DT_DEV_ID(node_id),	\
			      DEVICE_DT_NAME(node_id), init_fn, pm,	\
			      data, config, prio, api, mtu)
```
ETH_NET_DEVICE_DT_DEFINE 关键的变量:

| node_id | DT_N_S_soc_S_spi_40013000_S_w5500_0 |     |
| ------- | ----------------------------------- | --- |
| init_fn | w5500_init                          |     |
| pm      | NULL                                |     |
| data    | &w5500_0_runtime                    |     |
| config  | &w5500_0_config                     |     |
| prio    | CONFIG_ETH_INIT_PRIORITY            |     |
| api     | &w5500_api_funcs                    |     |
| mtu     | NET_ETH_MTU                         |     |


| Z_DEVICE_DT_DEV_ID(node_id) | dts_ord_102 |
| --------------------------- | ----------- |
```
#define DT_N_S_soc_S_spi_40013000_S_w5500_0_ORD 102

Z_DEVICE_DT_DEV_ID(node_id)
=>Z_DEVICE_DT_DEP_ORD(node_id)
=>_CONCAT(dts_ord_, DT_DEP_ORD(node_id))
=> dts_ord_##node_id##_ORD => dts_ord_##DT_N_S_soc_S_spi_40013000_S_w5500_0_ORD
=> dts_ord_102
```

| DEVICE_DT_NAME(node_id) | "w5500@0" |
| ----------------------- | --------- |
```
DEVICE_DT_NAME(node_id)
=>DT_PROP_OR(node_id, label, DT_NODE_FULL_NAME(node_id))
=> node_id##_P_##label  (不存在) =>DT_NODE_FULL_NAME(node_id)
=> node_id##_FULL_NAME

#define DT_N_S_soc_S_spi_40013000_S_w5500_0_FULL_NAME "w5500@0"

```

---
# [[Z_ETH_NET_DEVICE_INIT]]
```c
#define Z_ETH_NET_DEVICE_INIT(node_id, dev_id, name, init_fn, pm, data,	\
			      config, prio, api, mtu)			\
	Z_ETH_NET_DEVICE_INIT_INSTANCE(node_id, dev_id, name, 0,	\
				       init_fn, pm, data, config, prio,	\
				       api, mtu)
```
Z_ETH_NET_DEVICE_INIT 关键的变量:

| node_id | DT_N_S_soc_S_spi_40013000_S_w5500_0 |     |
| ------- | ----------------------------------- | --- |
| dev_id  | dts_ord_102                         |     |
| name    | DEVICE_DT_NAME(node_id)             |     |
| init_fn | w5500_init                          |     |
| pm      | NULL                                |     |
| data    | &w5500_0_runtime                    |     |
| config  | &w5500_0_config                     |     |
| prio    | CONFIG_ETH_INIT_PRIORITY            |     |
| api     | &w5500_api_funcs                    |     |
| mtu     | NET_ETH_MTU                         |     |

---
# [[Z_ETH_NET_DEVICE_INIT_INSTANCE]]
```c
#define Z_ETH_NET_DEVICE_INIT_INSTANCE(node_id, dev_id, name, instance,	\
				       init_fn, pm, data, config, prio,	\
				       api, mtu)			\
	Z_DEVICE_STATE_DEFINE(dev_id);					\
	Z_DEVICE_DEFINE(node_id, dev_id, name, init_fn, NULL,		\
			Z_DEVICE_DT_FLAGS(node_id), pm, data,		\
			config, POST_KERNEL, prio, api,			\
			&Z_DEVICE_STATE_NAME(dev_id));
```
Z_ETH_NET_DEVICE_INIT_INSTANCE 关键变量:

| node_id | DT_N_S_soc_S_spi_40013000_S_w5500_0 |
| ------- | ----------------------------------- |
| dev_id  | dts_ord_102                         |
| name    | "w5500@0"                           |
| init_fn | w5500_init                          |
| pm      | NULL                                |
| data    | &w5500_0_runtime                    |
| config  | &w5500_0_config                     |
| prio    | CONFIG_ETH_INIT_PRIORITY            |
| api     | &w5500_api_funcs                    |
| mtu     | NET_ETH_MTU                         |

---
# [[Z_DEVICE_STATE_DEFINE]]
  [[Z_DECL_ALIGN]] /  [[Z_DEVICE_STATE_NAME]]
```
#define Z_DEVICE_STATE_DEFINE(dev_id) \
	static Z_DECL_ALIGN(struct device_state) Z_DEVICE_STATE_NAME(dev_id)   \
		__attribute__((__section__(".z_devstate")))
```

```
=> __aligned(__alignof(struct device_state)) struct device_state __devstate_##dev_id __attribute__((__section__(".z_devstate")))
```

---

# [[Z_DEVICE_DEFINE]]

```
			
#define Z_DEVICE_DEFINE(node_id, dev_id, name, init_fn, deinit_fn, flags, pm, data, config, level, prio, api, state, ...)
```



| Z_DEVICE_DT_FLAGS(node_id) |     |
| -------------------------- | --- |

变量:

| node_id   | DT_N_S_soc_S_spi_40013000_S_w5500_0 |
| --------- | ----------------------------------- |
| dev_id    | dts_ord_102                         |
| name      | "w5500@0"                           |
| init_fn   | w5500_init                          |
| deinit_fn | NULL                                |
| flags     | Z_DEVICE_DT_FLAGS(node_id)          |
| pm        | NULL                                |
| data      | &w5500_0_runtime                    |
| config    | &w5500_0_config                     |
| level     | POST_KERNEL                         |
| prio      | CONFIG_ETH_INIT_PRIORITY            |
| api       | &w5500_api_funcs                    |
| state     | &Z_DEVICE_STATE_NAME(dev_id)        |

# => [[示例Device]]
